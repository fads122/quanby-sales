<app-sidebar></app-sidebar>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div class="search-bar">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input
              pInputText
              type="text"
              [(ngModel)]="searchQuery"
              placeholder="Search delivery receipts..."
              class="p-inputtext-sm"/>
          </span>
          <button
            pButton
            icon="pi pi-plus"
            label="Create Slip"
            class="p-button-primary"
            (click)="openCreateSlipDialog()">
          </button>
        </div>
      </div>

      <p-table
        #dt
        [value]="deliveryReceipts"
        [rows]="10"
        [paginator]="true"
        [globalFilterFields]="['project_name', 'client_name', 'delivery_date', 'status']"
        [tableStyle]="{'min-width': '75rem'}"
        [rowHover]="true"
        dataKey="id"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rowsPerPageOptions]="[10,25,50]">

        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="project_name">
              Project Name
              <p-sortIcon field="project_name"></p-sortIcon>
            </th>
            <th pSortableColumn="client_name">
              Client Name
              <p-sortIcon field="client_name"></p-sortIcon>
            </th>
            <th pSortableColumn="delivery_date">
              Delivery Date
              <p-sortIcon field="delivery_date"></p-sortIcon>
            </th>
            <th pSortableColumn="status">
              Status
              <p-sortIcon field="status"></p-sortIcon>
            </th>
            <th>Attached File</th>
            <th>Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-slip>
          <tr>
            <td>{{slip.project_name}}</td>
            <td>{{slip.client_name}}</td>
            <td>{{slip.delivery_date | date:'mediumDate'}}</td>
            <td>
              <p-tag
                [severity]="slip.status === 'Delivered' ? 'success' : 'warning'"
                [value]="slip.status">
              </p-tag>
            </td>
            <td>
              <div class="attachment-cell">
                <span *ngIf="isImage(slip.attached_file)"
                      (click)="openImageDialog(slip.attached_file)"
                      class="attachment-preview">
                  <img [src]="slip.attached_file" alt="Preview" />
                </span>
                <span *ngIf="isPdf(slip.attached_file)"
                      (click)="openPdfDialog(slip.attached_file)"
                      class="attachment-preview pdf">
                  <i class="pi pi-file-pdf"></i>
                </span>
                <span *ngIf="!slip.attached_file" class="no-file">
                  <i class="pi pi-file-excel"></i> No File
                </span>
              </div>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  pButton
                  icon="pi pi-eye"
                  class="p-button-rounded p-button-info p-button-sm mr-2"
                  (click)="viewDetails(slip)"
                  pTooltip="View Details">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center">No delivery receipts found.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Dialog Template Moved OUTSIDE table to prevent flickering -->
  <ng-template #imageDialog let-data>
    <div class="image-modal">
      <img *ngIf="isImage(data.imageUrl)"
           [src]="data.imageUrl"
           class="full-image"
           alt="Full View" />

      <iframe *ngIf="isPdf(data.imageUrl)"
              [src]="sanitizeUrl(data.imageUrl)"
              class="pdf-viewer"
              width="100%" height="100%" frameborder="0">
      </iframe>
    </div>
  </ng-template>

  <!-- Add Slip Dialog -->
  <!-- <ng-template #addSlipDialog>
    <h2 mat-dialog-title>Create Delivery Slip</h2>
    <form [formGroup]="slipForm" class="dialog-form" (ngSubmit)="createSlip()">
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Delivered To</mat-label>
          <input matInput formControlName="delivered_to" required />
          <mat-error *ngIf="slipForm.get('delivered_to')?.invalid && slipForm.get('delivered_to')?.touched">
            Delivered To is required.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Address</mat-label>
          <input matInput formControlName="address" rows="3" required>
          <mat-error *ngIf="slipForm.get('address')?.invalid && slipForm.get('address')?.touched">
            Address is required.
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Delivered By</mat-label>
          <input matInput formControlName="delivered_by" required />
          <mat-error *ngIf="slipForm.get('delivered_by')?.invalid && slipForm.get('delivered_by')?.touched">
            Delivered By is required.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Date Received</mat-label>
          <input matInput type="date" formControlName="date_received" required />
          <mat-error *ngIf="slipForm.get('date_received')?.invalid && slipForm.get('date_received')?.touched">
            Date Received is required.
          </mat-error>
        </mat-form-field>
      </div>

      <div class="file-upload">
        <label for="fileInput" class="file-upload-label">
          <span class="file-upload-text">{{ selectedFile || 'Choose File' }}</span>
          <span class="file-upload-button">Browse</span>
        </label>
        <input
          id="fileInput"
          type="file"
          accept="image/*,.pdf"
          (change)="onFileSelected($event)"
          class="file-input"
        />
        <div class="error-message" *ngIf="fileError">
          {{ fileError }}
        </div>
      </div>

      <div class="actions">
        <button mat-button type="button" (click)="closeDialog()">Cancel</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="slipForm.invalid || fileError">
          Create Slip
        </button>
      </div>
    </form>
  </ng-template> -->


  <ng-template #viewSlipDialog let-data>
    <h2 mat-dialog-title class="dialog-title">ðŸ“¦ Delivery Slip Details</h2>

    <mat-dialog-content class="dialog-content">
      <div class="details-box">
        <mat-icon color="primary">info</mat-icon>
        <div class="details-text">
          <p><strong>Project Name:</strong> {{ data.project_name }}</p>
          <p><strong>Client Name:</strong> {{ data.client_name }}</p>
          <p><strong>Delivery Date:</strong> {{ data.delivery_date || 'Not delivered yet' }}</p>
          <p><strong>Status:</strong> {{ data.status }}</p>
        </div>
      </div>

      <div class="file-section">
        <label for="fileInput"><strong>Attach File:</strong></label>
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" (change)="onFileSelectedForUpdate($event, data)" />
          <span class="file-name" *ngIf="selectedUpdateFile">{{ selectedUpdateFile.name }}</span>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Received By</mat-label>
        <input matInput [(ngModel)]="data.received_by" placeholder="Enter recipient's name" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Delivered Date</mat-label>
        <input matInput [matDatepicker]="picker" [(ngModel)]="data.delivered_date" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Delivered Time</mat-label>
        <input matInput type="time" [(ngModel)]="data.delivered_time" placeholder="HH:mm" />
      </mat-form-field>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-stroked-button color="warn" (click)="closeDialog()">Close</button>
      <button
        mat-raised-button
        color="primary"
        (click)="saveUpdatedFile(data)"
        [disabled]="!selectedUpdateFile"
      >
        Save
      </button>
    </mat-dialog-actions>
  </ng-template>



</body>
