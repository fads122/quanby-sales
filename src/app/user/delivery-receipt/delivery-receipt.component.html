<div class="layout-container">
  <app-sidebar></app-sidebar>

  <div class="main-content">
    <div class="content-container">
      <div class="header-controls">
  <div class="header-section">
    <h1>Delivery Receipts</h1>
    <p class="subtitle">Track all your delivery receipts in one place</p>
  </div>

  <div class="right-controls">
    <mat-form-field appearance="outline" class="search-input">
      <mat-icon matPrefix>search</mat-icon>
      <input matInput placeholder="Search receipts..." [(ngModel)]="searchQuery" (input)="filterReceipts()">
    </mat-form-field>
  </div>
</div>


      <mat-card style="margin-bottom: 50px;" backgroundColor=" black">
        <mat-card-content>
          <div class="mat-elevation-z8">
            <table mat-table [dataSource]="filteredReceipts" matSort>
              <!-- Project Column -->
              <ng-container matColumnDef="project">
                <th mat-header-cell *matHeaderCellDef>Project</th>
                <td mat-cell *matCellDef="let receipt">
                  <span class="project-name">{{receipt.project_name}}</span>
                </td>
              </ng-container>

              <!-- Client Column -->
              <ng-container matColumnDef="client">
                <th mat-header-cell *matHeaderCellDef>Client</th>
                <td mat-cell *matCellDef="let receipt">
                  {{receipt.client_name}}
                </td>
              </ng-container>

              <!-- Delivery Date Column -->
              <ng-container matColumnDef="delivery_date">
                <th mat-header-cell *matHeaderCellDef>Delivery Date</th>
                <td mat-cell *matCellDef="let receipt">
                  {{receipt.delivery_date || 'Not delivered'}}
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let receipt">
                  <mat-chip [color]="getStatusColor(receipt.status)" [class.status-delivered]="receipt.status === 'Delivered'">
                    {{receipt.status}}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Attachment Column -->
              <ng-container matColumnDef="attachment">
                <th mat-header-cell *matHeaderCellDef>Attachment</th>
                <td mat-cell *matCellDef="let receipt">
                  <div *ngIf="receipt.attached_file" class="attachment-container">
                    <button mat-icon-button (click)="openFileDialog(receipt.attached_file)">
                      <mat-icon *ngIf="isImage(receipt.attached_file)">image</mat-icon>
                      <mat-icon *ngIf="isPdf(receipt.attached_file)">picture_as_pdf</mat-icon>
                    </button>
                    <span class="file-name">
                      {{receipt.attached_file.split('/').pop() | slice:0:20}}
                      {{receipt.attached_file.split('/').pop().length > 20 ? '...' : ''}}
                    </span>
                  </div>
                  <span *ngIf="!receipt.attached_file">No attachment</span>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="text-right">Actions</th>
                <td mat-cell *matCellDef="let receipt" class="text-right">
                  <div class="action-buttons">
                    <button mat-icon-button color="primary" (click)="showReceiptDetails(receipt)" matTooltip="View details">
                      <mat-icon>visibility</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <mat-paginator [length]="filteredReceipts.length"
                          [pageSize]="rows"
                          [pageSizeOptions]="[10, 25, 50, 100]"
                          (page)="pageChange($event)"
                          showFirstLastButtons>
            </mat-paginator>

            <div *ngIf="filteredReceipts.length === 0 && !loading" class="empty-state">
              <mat-icon class="empty-icon">local_shipping</mat-icon>
              <h4 class="empty-title">No delivery receipts found</h4>
              <p class="empty-description">
                You haven't recorded any deliveries yet.
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Receipt Details Dialog -->
<ng-template #receiptDetailsDialog>
  <h2 mat-dialog-title>Delivery Receipt Details</h2>
  <mat-dialog-content *ngIf="selectedReceipt">
    <div class="client-details-container">
      <div class="detail-row">
        <span class="detail-label">Project:</span>
        <span class="detail-value">{{selectedReceipt.project_name}}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Client:</span>
        <span class="detail-value">{{selectedReceipt.client_name}}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Delivery Date:</span>
        <span class="detail-value">{{selectedReceipt.delivery_date || 'Not delivered'}}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Status:</span>
        <span class="detail-value">
          <mat-chip [color]="getStatusColor(selectedReceipt.status)">
            {{selectedReceipt.status}}
          </mat-chip>
        </span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Received By:</span>
        <span class="detail-value">
          <input matInput [(ngModel)]="selectedReceipt.received_by" placeholder="Enter recipient name">
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Delivered Date:</span>
        <span class="detail-value">
          <input matInput type="date" [(ngModel)]="selectedReceipt.delivered_date">
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Delivered Time:</span>
        <span class="detail-value">
          <input matInput type="time" [(ngModel)]="selectedReceipt.delivered_time">
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Attachment:</span>
        <span class="detail-value">
          <input type="file" (change)="onFileSelectedForUpdate($event, selectedReceipt)">
          <span *ngIf="selectedUpdateFile" class="file-name">{{selectedUpdateFile.name}}</span>
        </span>
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-raised-button color="primary" (click)="saveUpdatedFile(selectedReceipt!)">Save</button>
  </mat-dialog-actions>
</ng-template>

<!-- File Dialog -->
<ng-template #fileDialog let-data>
  <div class="file-dialog-container">
    <img *ngIf="isImage(data.url)" [src]="data.url" class="file-preview">
    <iframe *ngIf="isPdf(data.url)" [src]="sanitizeUrl(data.url)" class="file-preview pdf"></iframe>
  </div>
</ng-template>
