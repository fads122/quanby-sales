<app-sidebar></app-sidebar>
<body>
  <div class="search-borrow-container">
  <!-- 🔍 Search Bar (Left) -->
  <span class="p-input-icon-left search-wrapper">
    <i class="pi pi-search"></i>
    <input 
      type="text" 
      pInputText 
      class="search-input" 
      placeholder="Search Borrower Department"
      [(ngModel)]="searchTerm" 
      (input)="filterBorrowRequests()" 
    />
  </span>

  <!-- ➕ Borrow Button (Right) -->
  <button class="borrow-item-btn" (click)="goToBorrowForm()">
    <i class="pi pi-plus"></i> Borrow Item
  </button>
</div>
  <br>

    <!-- ✅ Angular Material Table -->
  <div class="mat-table-container">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
      <!-- Borrower Name Column -->
      <ng-container matColumnDef="borrower_name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Borrower Name </th>
        <td mat-cell *matCellDef="let request"> {{request.borrower_name}} </td>
      </ng-container>

      <!-- Department Column -->
      <ng-container matColumnDef="borrower_department">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Department/Location </th>
        <td mat-cell *matCellDef="let request"> {{request.borrower_department}} </td>
      </ng-container>

      <!-- Borrow Date Column -->
      <ng-container matColumnDef="borrow_date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Borrow Date </th>
        <td mat-cell *matCellDef="let request"> {{request.borrow_date}} </td>
      </ng-container>

      <!-- Return Date Column -->
      <ng-container matColumnDef="return_date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Return Date </th>
        <td mat-cell *matCellDef="let request"> {{request.return_date}} </td>
      </ng-container>

      <!-- Action Column -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef> Action </th>
        <td mat-cell *matCellDef="let request">
          <button *ngIf="request.status !== 'Returned' && request.status !== 'returned'"
                  mat-raised-button color="primary" class="action-btn"
                  (click)="markAsReturned(request.id); $event.stopPropagation()">
            Return
          </button>
          <span *ngIf="request.status?.toLowerCase() === 'returned'" class="returned-label">
            Returned
          </span>
        </td>
      </ng-container>

      <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
    (click)="openDetailsModal(getFullRequest(row.id))" class="clickable-row"></tr>

      <!-- No data row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="no-items" colspan="5">
          <mat-icon class="no-items-icon">inventory</mat-icon>
          <p class="no-items-message">No borrowed items found</p>
        </td>
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[8, 10, 15, 20]" showFirstLastButtons></mat-paginator>
  </div>

    <!-- Add this modal container RIGHT HERE -->
  <div *ngIf="showDetailsModal" class="modal-backdrop">
    <div class="modal-content">
      <ng-container *ngTemplateOutlet="borrowDetailsModal"></ng-container>
    </div>
  </div>

<!-- In your main component template (keep this at the bottom) -->
<ng-template #borrowDetailsModal>
  <div class="dialog-container">
    <!-- Close Button -->
    <button mat-icon-button class="close-button" (click)="closeDetailsModal()">
      <mat-icon>close</mat-icon>
    </button>
    
    <!-- Borrower Information -->
    <div class="borrower-info">
      <h3>Borrower Information</h3>
      <div class="info-grid">
        <p><strong>Name:</strong> {{ selectedBorrower?.borrower_name }}</p>
        <p><strong>Department:</strong> {{ selectedBorrower?.borrower_department }}</p>
        <p><strong>Contact:</strong> {{ selectedBorrower?.borrower_contact }}</p>
        <p><strong>Email:</strong> {{ selectedBorrower?.borrower_email }}</p>
        <p><strong>Borrow Date:</strong> {{ selectedBorrower?.borrow_date }}</p>
        <p><strong>Return Date:</strong> {{ selectedBorrower?.return_date }}</p>
        <p><strong>Status:</strong>
          <span [ngClass]="{
            'status-pending': selectedBorrower?.status !== 'Returned',
            'status-returned': selectedBorrower?.status === 'Returned'
          }">
            {{ selectedBorrower?.status }}
          </span>
        </p>
      </div>
      <div class="purpose-container">
        <strong>Purpose:</strong>
        <span class="purpose-content">
          {{ selectedBorrower?.purpose || 'No purpose specified' }}
        </span>
      </div>
    </div>

    <!-- Borrowed Equipment Section -->
    <h3 class="equipment-title">Borrowed Equipment</h3>
    <div *ngIf="selectedBorrower?.equipmentList?.length; else noEquipment" class="equipment-grid">
      <mat-card class="equipment-card" *ngFor="let item of selectedBorrower.equipmentList">
        <img [src]="getImagePath(item.image)" alt="{{ item.name }}" class="equipment-image"/>
        <mat-card-content class="equipment-details">
          <h4>{{ item.name }}</h4>
          <p>Quantity: <strong>{{ item.quantity }}</strong></p>
        </mat-card-content>
      </mat-card>
    </div>

    <ng-template #noEquipment>
      <p class="no-equipment">No equipment was borrowed in this request</p>
    </ng-template>

    <!-- PDF Viewer -->
    <div *ngIf="selectedBorrower?.attached_file && isPdf(selectedBorrower.attached_file)" class="pdf-container">
      <iframe
        [src]="sanitizeUrl(selectedBorrower.attached_file)"
        class="pdf-viewer"
        frameborder="0">
      </iframe>
    </div>
  </div>
</ng-template>
</body>
